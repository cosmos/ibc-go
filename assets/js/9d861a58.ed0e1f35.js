"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[77983],{3233:(e,i,t)=>{t.r(i),t.d(i,{assets:()=>o,contentTitle:()=>s,default:()=>c,frontMatter:()=>a,metadata:()=>p,toc:()=>d});var n=t(74848),r=t(28453);const a={title:"Support the new StackBuilder primitive for Wiring Middlewares in the chain application",sidebar_label:"Support StackBuilder Wiring",sidebar_position:1,slug:"/migrations/support-stackbuilder"},s="Migration for Chains wishing to use StackBuilder",p={id:"migrations/support-stackbuilder",title:"Support the new StackBuilder primitive for Wiring Middlewares in the chain application",description:"The StackBuilder struct is a new primitive for wiring middleware in a simpler and less error-prone manner. It is not a breaking change thus the existing method of wiring middleware still works, though it is highly recommended to transition to the new wiring method.",source:"@site/docs/05-migrations/15-support-stackbuilder.md",sourceDirName:"05-migrations",slug:"/migrations/support-stackbuilder",permalink:"/main/migrations/support-stackbuilder",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Support the new StackBuilder primitive for Wiring Middlewares in the chain application",sidebar_label:"Support StackBuilder Wiring",sidebar_position:1,slug:"/migrations/support-stackbuilder"},sidebar:"defaultSidebar",previous:{title:"Support transfer of coins whose base denom contains slashes",permalink:"/main/migrations/support-denoms-with-slashes"},next:{title:"SDK v0.43 to IBC-Go v1",permalink:"/main/migrations/sdk-to-v1"}},o={},d=[];function l(e){const i={a:"a",code:"code",h1:"h1",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.h1,{id:"migration-for-chains-wishing-to-use-stackbuilder",children:"Migration for Chains wishing to use StackBuilder"}),"\n",(0,n.jsx)(i.p,{children:"The StackBuilder struct is a new primitive for wiring middleware in a simpler and less error-prone manner. It is not a breaking change thus the existing method of wiring middleware still works, though it is highly recommended to transition to the new wiring method."}),"\n",(0,n.jsxs)(i.p,{children:["Refer to the ",(0,n.jsx)(i.a,{href:"/main/ibc/middleware/integration",children:"integration guide"})," to understand how to use this new middleware to improve middleware wiring in the chain application setup."]}),"\n",(0,n.jsx)(i.h1,{id:"migrations-for-application-developers",children:"Migrations for Application Developers"}),"\n",(0,n.jsx)(i.p,{children:"In order to be wired with the new StackBuilder primitive, applications and middlewares must implement new methods as part of their respective interfaces."}),"\n",(0,n.jsxs)(i.p,{children:["IBC Applications must implement a new ",(0,n.jsx)(i.code,{children:"SetICS4Wrapper"})," which will set the ",(0,n.jsx)(i.code,{children:"ICS4Wrapper"})," through which the application will call ",(0,n.jsx)(i.code,{children:"SendPacket"})," and ",(0,n.jsx)(i.code,{children:"WriteAcknowledgement"}),". It is recommended that IBC applications are initialized first with the IBC ChannelKeeper directly, and then modified with a middleware ICS4Wrapper during the stack wiring."]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-go",children:"// SetICS4Wrapper sets the ICS4Wrapper. This function may be used after\n// the module's initialization to set the middleware which is above this\n// module in the IBC application stack.\n// The ICS4Wrapper **must** be used for sending packets and writing acknowledgements\n// to ensure that the middleware can intercept and process these calls.\n// Do not use the channel keeper directly to send packets or write acknowledgements\n// as this will bypass the middleware.\nSetICS4Wrapper(wrapper ICS4Wrapper)\n"})}),"\n",(0,n.jsxs)(i.p,{children:["Many applications have a stateful keeper that executes the logic for sending packets and writing acknowledgements. In this case, the keeper in the application must be a ",(0,n.jsx)(i.strong,{children:"pointer"})," reference so that it can be modified in place after initialization."]}),"\n",(0,n.jsxs)(i.p,{children:["The initialization should be modified to no longer take in an addition ",(0,n.jsx)(i.code,{children:"ics4Wrapper"})," as this gets modified later by ",(0,n.jsx)(i.code,{children:"SetICS4Wrapper"}),". The constructor function must also return a ",(0,n.jsx)(i.strong,{children:"pointer"})," reference so that it may be modified in-place by the stack builder."]}),"\n",(0,n.jsx)(i.p,{children:"Below is an example IBCModule that supports the stack builder wiring."}),"\n",(0,n.jsx)(i.p,{children:"E.g."}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-go",children:'type IBCModule struct {\n\tkeeper *keeper.Keeper\n}\n\n// NewIBCModule creates a new IBCModule given the keeper\nfunc NewIBCModule(k *keeper.Keeper) *IBCModule {\n\treturn &IBCModule{\n\t\tkeeper: k,\n\t}\n}\n\n// SetICS4Wrapper sets the ICS4Wrapper. This function may be used after\n// the module\'s initialization to set the middleware which is above this\n// module in the IBC application stack.\nfunc (im IBCModule) SetICS4Wrapper(wrapper porttypes.ICS4Wrapper) {\n\tif wrapper == nil {\n\t\tpanic("ICS4Wrapper cannot be nil")\n\t}\n\n\tim.keeper.WithICS4Wrapper(wrapper)\n}\n\n/// Keeper file that has ICS4Wrapper internal to its own struct\n\n// Keeper defines the IBC fungible transfer keeper\ntype Keeper struct {\n\t...\n\tics4Wrapper   porttypes.ICS4Wrapper\n\n    // Keeper is initialized with ICS4Wrapper\n    // being equal to the top-level channelKeeper\n    // this can be changed by calling WithICS4Wrapper\n    // with a different middleware ICS4Wrapper\n\tchannelKeeper types.ChannelKeeper\n\t...\n}\n\n// WithICS4Wrapper sets the ICS4Wrapper. This function may be used after\n// the keepers creation to set the middleware which is above this module\n// in the IBC application stack.\nfunc (k *Keeper) WithICS4Wrapper(wrapper porttypes.ICS4Wrapper) {\n\tk.ics4Wrapper = wrapper\n}\n'})}),"\n",(0,n.jsx)(i.h1,{id:"migration-for-middleware-developers",children:"Migration for Middleware Developers"}),"\n",(0,n.jsxs)(i.p,{children:["Since Middleware is itself implement the IBC application interface, it must also implement ",(0,n.jsx)(i.code,{children:"SetICS4Wrapper"})," in the same way as IBC applications."]}),"\n",(0,n.jsxs)(i.p,{children:["Additionally, IBC Middleware has an underlying IBC application that it calls into as well. Previously this application would be set in the middleware upon construction. With the stack builder primitive, the application is only set during upon calling ",(0,n.jsx)(i.code,{children:"stack.Build()"}),". Thus, middleware is additionally responsible for implementing the new method: ",(0,n.jsx)(i.code,{children:"SetUnderlyingApplication"}),":"]}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-go",children:"// SetUnderlyingModule sets the underlying IBC module. This function may be used after\n// the middleware's initialization to set the ibc module which is below this middleware.\nSetUnderlyingApplication(IBCModule)\n"})}),"\n",(0,n.jsxs)(i.p,{children:["The initialization should not include the ICS4Wrapper and application as this gets set later. The constructor function for Middlewares ",(0,n.jsx)(i.strong,{children:"must"})," be modified to return a ",(0,n.jsx)(i.strong,{children:"pointer"})," reference so that it can be modified in place by the stack builder."]}),"\n",(0,n.jsx)(i.p,{children:"Below is an example middleware setup:"}),"\n",(0,n.jsx)(i.pre,{children:(0,n.jsx)(i.code,{className:"language-go",children:'// IBCMiddleware implements the ICS26 callbacks\ntype IBCMiddleware struct {\n\tapp         porttypes.PacketUnmarshalerModule\n\tics4Wrapper porttypes.ICS4Wrapper\n\n    // this is a stateful middleware with its own internal keeper\n\tmwKeeper *keeper.MiddlewareKeeper\n\n\t// this is a middleware specific field\n\tmwField any\n}\n\n// NewIBCMiddleware creates a new IBCMiddleware given the keeper and underlying application.\n// NOTE: It **must** return a pointer reference so it can be\n// modified in place by the stack builder\n// NOTE: We do not pass in the underlying app and ICS4Wrapper here as this happens later\nfunc NewIBCMiddleware(\n\tmwKeeper *keeper.MiddlewareKeeper, mwField any,\n) *IBCMiddleware {\n    return &IBCMiddleware{\n        mwKeeper: mwKeeper,\n        mwField, mwField,\n    }\n}\n\n// SetICS4Wrapper sets the ICS4Wrapper. This function may be used after the\n// middleware\'s creation to set the middleware which is above this module in\n// the IBC application stack.\nfunc (im *IBCMiddleware) SetICS4Wrapper(wrapper porttypes.ICS4Wrapper) {\n\tif wrapper == nil {\n\t\tpanic("ICS4Wrapper cannot be nil")\n\t}\n\tim.mwKeeper.WithICS4Wrapper(wrapper)\n}\n\n// SetUnderlyingApplication sets the underlying IBC module. This function may be used after\n// the middleware\'s creation to set the ibc module which is below this middleware.\nfunc (im *IBCMiddleware) SetUnderlyingApplication(app porttypes.IBCModule) {\n\tif app == nil {\n\t\tpanic(errors.New("underlying application cannot be nil"))\n\t}\n\tif im.app != nil {\n\t\tpanic(errors.New("underlying application already set"))\n\t}\n\tim.app = app\n}\n'})})]})}function c(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,n.jsx)(i,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},28453:(e,i,t)=>{t.d(i,{R:()=>s,x:()=>p});var n=t(96540);const r={},a=n.createContext(r);function s(e){const i=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function p(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),n.createElement(a.Provider,{value:i},e.children)}}}]);