"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[50037],{28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>r});var t=s(96540);const o={},i=t.createContext(o);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(i.Provider,{value:n},e.children)}},69740:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>r,toc:()=>d});var t=s(74848),o=s(28453);const i={},a="ADR 003: ICS27 Acknowledgement Format",r={id:"adr-003-ics27-acknowledgement",title:"ADR 003: ICS27 Acknowledgement Format",description:"Changelog",source:"@site/architecture/adr-003-ics27-acknowledgement.md",sourceDirName:".",slug:"/adr-003-ics27-acknowledgement",permalink:"/architecture/adr-003-ics27-acknowledgement",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"ADR 002: Go module versioning",permalink:"/architecture/adr-002-go-module-versioning"},next:{title:"ADR 004: Lock fee module upon escrow out of balance",permalink:"/architecture/adr-004-ics29-lock-fee-module"}},c={},d=[{value:"Changelog",id:"changelog",level:2},{value:"Status",id:"status",level:2},{value:"Context",id:"context",level:2},{value:"Decision",id:"decision",level:2},{value:"Successful acknowledgements",id:"successful-acknowledgements",level:3},{value:"v0.45 format",id:"v045-format",level:4},{value:"Next major version format",id:"next-major-version-format",level:4},{value:"Forwards compatible approach",id:"forwards-compatible-approach",level:4},{value:"Decision",id:"decision-1",level:4},{value:"Error acknowledgements",id:"error-acknowledgements",level:3},{value:"Consequences",id:"consequences",level:2},{value:"Positive",id:"positive",level:3},{value:"Negative",id:"negative",level:3},{value:"Neutral",id:"neutral",level:3}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"adr-003-ics27-acknowledgement-format",children:"ADR 003: ICS27 Acknowledgement Format"}),"\n",(0,t.jsx)(n.h2,{id:"changelog",children:"Changelog"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"January 28th, 2022: Initial Draft"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"status",children:"Status"}),"\n",(0,t.jsx)(n.p,{children:"Accepted"}),"\n",(0,t.jsx)(n.h2,{id:"context",children:"Context"}),"\n",(0,t.jsx)(n.p,{children:"Upon receiving an IBC packet, an IBC application can optionally return an acknowledgement.\nThis acknowledgement will be hashed and written into state. Thus any changes to the information included in an acknowledgement are state machine breaking."}),"\n",(0,t.jsx)(n.p,{children:"ICS27 executes transactions on behalf of a controller chain. Information such as the message result or message error may be returned from other SDK modules outside the control of the ICS27 module.\nIt might be very valuable to return message execution information inside the ICS27 acknowledgement so that controller chain interchain account auth modules can act upon this information.\nOnly deterministic information returned from the message execution is allowed to be returned in the packet acknowledgement otherwise the network will halt due to a fork in the expected app hash."}),"\n",(0,t.jsx)(n.h2,{id:"decision",children:"Decision"}),"\n",(0,t.jsxs)(n.p,{children:["At the time of this writing, Tendermint includes the following information in the ",(0,t.jsx)(n.a,{href:"https://github.com/tendermint/tendermint/blob/release/v0.34.13/types/results.go#L47-#L53",children:"ABCI.ResponseDeliverTx"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// deterministicResponseDeliverTx strips non-deterministic fields from\n// ResponseDeliverTx and returns another ResponseDeliverTx.\nfunc deterministicResponseDeliverTx(response *abci.ResponseDeliverTx) *abci.ResponseDeliverTx {\n  return &abci.ResponseDeliverTx{\n    Code:      response.Code,\n    Data:      response.Data,\n    GasWanted: response.GasWanted,\n    GasUsed:   response.GasUsed,\n  }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"successful-acknowledgements",children:"Successful acknowledgements"}),"\n",(0,t.jsxs)(n.p,{children:["Successful acknowledgements should return information about the transaction execution.\nGiven the deterministic fields in the ",(0,t.jsx)(n.code,{children:"abci.ResponseDeliverTx"}),", the transaction ",(0,t.jsx)(n.code,{children:"Data"})," can be used to indicate information about the transaction execution.\nThe ",(0,t.jsx)(n.code,{children:"abci.ResponseDeliverTx.Data"})," will be set in the ICS27 packet acknowledgement upon successful transaction execution."]}),"\n",(0,t.jsxs)(n.p,{children:["The format for the ",(0,t.jsx)(n.code,{children:"abci.ResponseDeliverTx.Data"})," is constructed by the SDK."]}),"\n",(0,t.jsx)(n.p,{children:"At the time of this writing, the next major release of the SDK will change the format for constructing the transaction response data."}),"\n",(0,t.jsx)(n.h4,{id:"v045-format",children:"v0.45 format"}),"\n",(0,t.jsx)(n.p,{children:"The current version, v0.45 constructs the transaction response as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"proto.Marshal(&sdk.TxMsgData{\n  Data: []*sdk.MsgData{msgResponses...}, \n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Where ",(0,t.jsx)(n.code,{children:"msgResponses"})," is a slice of ",(0,t.jsx)(n.code,{children:"*sdk.MsgData"}),".\nThe ",(0,t.jsx)(n.code,{children:"MsgData.MsgType"})," contains the ",(0,t.jsx)(n.code,{children:"sdk.MsgTypeURL"})," of the ",(0,t.jsx)(n.code,{children:"sdk.Msg"})," being executed.\nThe ",(0,t.jsx)(n.code,{children:"MsgData.Data"})," contains the proto marshaled ",(0,t.jsx)(n.code,{children:"MsgResponse"})," for the associated message executed."]}),"\n",(0,t.jsx)(n.h4,{id:"next-major-version-format",children:"Next major version format"}),"\n",(0,t.jsx)(n.p,{children:"The next major version will construct the transaction response as follows:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"proto.Marshal(&sdk.TxMsgData{\n  MsgResponses: []*codectypes.Any{msgResponses...}, \n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Where ",(0,t.jsx)(n.code,{children:"msgResponses"})," is a slice of the ",(0,t.jsx)(n.code,{children:"MsgResponse"}),"s packed into ",(0,t.jsx)(n.code,{children:"Any"}),"s."]}),"\n",(0,t.jsx)(n.h4,{id:"forwards-compatible-approach",children:"Forwards compatible approach"}),"\n",(0,t.jsxs)(n.p,{children:["A forwards compatible approach was deemed infeasible.\nThe ",(0,t.jsx)(n.code,{children:"handler"})," provided by the ",(0,t.jsx)(n.code,{children:"MsgServiceRouter"})," will only include the ",(0,t.jsx)(n.code,{children:"*sdk.Result"})," and an error (if one occurred).\nIn v0.45 of the SDK, the ",(0,t.jsx)(n.code,{children:"*sdk.Result.Data"})," will contain the MsgResponse marshaled data.\nHowever, the MsgResponse is not packed and marshaled as a ",(0,t.jsx)(n.code,{children:"*codectypes.Any"}),", thus making it impossible from a generalized point of view to unmarshal the bytes.\nIf the bytes could be unmarshaled, then they could be packed into an ",(0,t.jsx)(n.code,{children:"*codectypes.Any"})," in anticipation of the upcoming format."]}),"\n",(0,t.jsxs)(n.p,{children:["Intercepting the MsgResponse before it becomes marshaled requires replicating this ",(0,t.jsx)(n.a,{href:"https://github.com/cosmos/cosmos-sdk/blob/dfd47f5b449f558a855da284a9a7eabbfbad435d/baseapp/msg_service_router.go#L109-#L128",children:"code"}),".\nIt may not even be possible to replicate the linked code. The method handler would need to be accessed somehow."]}),"\n",(0,t.jsx)(n.p,{children:"For these reasons it is deemed infeasible to attempt a forwards compatible approach."}),"\n",(0,t.jsxs)(n.p,{children:["ICA auth developers can interpret which format was used when constructing the transaction response by checking if the ",(0,t.jsx)(n.code,{children:"sdk.TxMsgData.Data"})," field is non-empty.\nIf the ",(0,t.jsx)(n.code,{children:"sdk.TxMsgData.Data"})," field is not empty then the format for v0.45 was used, otherwise ICA auth developers can assume the transaction response uses the newer format."]}),"\n",(0,t.jsx)(n.h4,{id:"decision-1",children:"Decision"}),"\n",(0,t.jsx)(n.p,{children:"Replicate the transaction response format as provided by the current SDK version.\nWhen the SDK version changes, adjust the transaction response format to use the updated transaction response format.\nInclude the transaction response bytes in the result channel acknowledgement."}),"\n",(0,t.jsxs)(n.p,{children:["A test has been ",(0,t.jsx)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/v3.0.0/modules/apps/27-interchain-accounts/host/ibc_module_test.go#L716-#L774",children:"written"})," to fail if the ",(0,t.jsx)(n.code,{children:"MsgResponse"})," is no longer included in consensus."]}),"\n",(0,t.jsx)(n.h3,{id:"error-acknowledgements",children:"Error acknowledgements"}),"\n",(0,t.jsxs)(n.p,{children:["As indicated above, the ",(0,t.jsx)(n.code,{children:"abci.ResponseDeliverTx.Code"})," is deterministic.\nUpon transaction execution errors, an error acknowledgement should be returned including the abci code."]}),"\n",(0,t.jsxs)(n.p,{children:["A test has been ",(0,t.jsx)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/v3.0.0/modules/apps/27-interchain-accounts/host/types/ack_test.go#L41-#L82",children:"written"})," to fail if the ABCI code is no longer deterministic."]}),"\n",(0,t.jsx)(n.h2,{id:"consequences",children:"Consequences"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:'This section describes the consequences, after applying the decision. All consequences should be summarized here, not just the "positive" ones.'}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"positive",children:"Positive"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"interchain account auth modules can act upon transaction results without requiring a query module"}),"\n",(0,t.jsx)(n.li,{children:"transaction results align with those returned by execution of a normal SDK message."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"negative",children:"Negative"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"the security assumptions of this decision rest on the inclusion of the ABCI error code and the Msg response in the ResponseDeliverTx hash created by Tendermint"}),"\n",(0,t.jsx)(n.li,{children:"events are non-deterministic and cannot be included in the packet acknowledgement"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"neutral",children:"Neutral"}),"\n",(0,t.jsx)(n.p,{children:"No neutral consequences."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);