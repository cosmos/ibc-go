"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[90233],{19921:(e,r,a)=>{a.r(r),a.d(r,{assets:()=>p,contentTitle:()=>o,default:()=>l,frontMatter:()=>i,metadata:()=>d,toc:()=>c});var n=a(74848),t=a(28453);const i={title:"Integration",sidebar_label:"Integration",sidebar_position:1,slug:"/apps/packet-forward-middleware/integration"},o="Integration",d={id:"middleware/packet-forward-middleware/integration",title:"Integration",description:"This document provides instructions on integrating and configuring the Packet Forward Middleware (PFM) within your",source:"@site/docs/04-middleware/02-packet-forward-middleware/02-integration.md",sourceDirName:"04-middleware/02-packet-forward-middleware",slug:"/apps/packet-forward-middleware/integration",permalink:"/main/apps/packet-forward-middleware/integration",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Integration",sidebar_label:"Integration",sidebar_position:1,slug:"/apps/packet-forward-middleware/integration"},sidebar:"defaultSidebar",previous:{title:"Overview",permalink:"/main/apps/packet-forward-middleware/overview"},next:{title:"Example Flows",permalink:"/main/apps/packet-forward-middleware/example-flows"}},p={},c=[{value:"Example integration of the Packet Forward Middleware",id:"example-integration-of-the-packet-forward-middleware",level:2},{value:"Configuring the transfer application stack with Packet Forward Middleware",id:"configuring-the-transfer-application-stack-with-packet-forward-middleware",level:2},{value:"Configurable options in the Packet Forward Middleware",id:"configurable-options-in-the-packet-forward-middleware",level:2}];function s(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.h1,{id:"integration",children:"Integration"}),"\n",(0,n.jsx)(r.p,{children:"This document provides instructions on integrating and configuring the Packet Forward Middleware (PFM) within your\nexisting chain implementation.\nThe integration steps include the following:"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsx)(r.li,{children:(0,n.jsx)(r.a,{href:"#example-integration-of-the-packet-forward-middleware",children:"Import the PFM, initialize the PFM Module & Keeper, initialize the store keys and module params, and initialize the Begin/End Block logic and InitGenesis order"})}),"\n",(0,n.jsx)(r.li,{children:(0,n.jsx)(r.a,{href:"#configuring-the-transfer-application-stack-with-packet-forward-middleware",children:"Configure the IBC application stack including the transfer module"})}),"\n",(0,n.jsx)(r.li,{children:(0,n.jsx)(r.a,{href:"#configurable-options-in-the-packet-forward-middleware",children:"Configuration of additional options such as timeout period, number of retries on timeout, refund timeout period, and fee percentage"})}),"\n"]}),"\n",(0,n.jsx)(r.p,{children:"Integration of the PFM should take approximately 20 minutes."}),"\n",(0,n.jsx)(r.h2,{id:"example-integration-of-the-packet-forward-middleware",children:"Example integration of the Packet Forward Middleware"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:'// app.go\n\n// Import the packet forward middleware\nimport (\n    "github.com/cosmos/ibc-apps/middleware/packet-forward-middleware/v10/packetforward"\n    packetforwardkeeper "github.com/cosmos/ibc-apps/middleware/packet-forward-middleware/v10/packetforward/keeper"\n    packetforwardtypes "github.com/cosmos/ibc-apps/middleware/packet-forward-middleware/v10/packetforward/types"\n)\n\n...\n\n// Register the AppModule for the packet forward middleware module\nModuleBasics = module.NewBasicManager(\n    ...\n    packetforward.AppModuleBasic{},\n    ...\n)\n\n...\n\n// Add packet forward middleware Keeper\ntype App struct {\n ...\n PacketForwardKeeper *packetforwardkeeper.Keeper\n ...\n}\n\n...\n\n// Create store keys\nkeys := sdk.NewKVStoreKeys(\n    ...\n    packetforwardtypes.StoreKey,\n    ...\n)\n\n...\n\n// Initialize the packet forward middleware Keeper\n// It\'s important to note that the PFM Keeper must be initialized before the Transfer Keeper\napp.PacketForwardKeeper = packetforwardkeeper.NewKeeper(\n    appCodec,\n    keys[packetforwardtypes.StoreKey],\n    nil, // will be zero-value here, reference is set later on with SetTransferKeeper.\n    app.IBCKeeper.ChannelKeeper,\n    appKeepers.DistrKeeper,\n    app.BankKeeper,\n    app.IBCKeeper.ChannelKeeper,\n    authtypes.NewModuleAddress(govtypes.ModuleName).String(),\n)\n\n// Initialize the transfer module Keeper\napp.TransferKeeper = ibctransferkeeper.NewKeeper(\n    appCodec,\n    keys[ibctransfertypes.StoreKey],\n    app.GetSubspace(ibctransfertypes.ModuleName),\n    app.PacketForwardKeeper,\n    app.IBCKeeper.ChannelKeeper,\n    &app.IBCKeeper.PortKeeper,\n    app.AccountKeeper,\n    app.BankKeeper,\n    scopedTransferKeeper,\n)\n\napp.PacketForwardKeeper.SetTransferKeeper(app.TransferKeeper)\n\n// See the section below for configuring an application stack with the packet forward middleware\n\n...\n\n// Register packet forward middleware AppModule\napp.moduleManager = module.NewManager(\n    ...\n    packetforward.NewAppModule(app.PacketForwardKeeper, app.GetSubspace(packetforwardtypes.ModuleName)),\n)\n\n...\n\n// Add packet forward middleware to begin blocker logic\napp.moduleManager.SetOrderBeginBlockers(\n    ...\n    packetforwardtypes.ModuleName,\n    ...\n)\n\n// Add packet forward middleware to end blocker logic\napp.moduleManager.SetOrderEndBlockers(\n    ...\n    packetforwardtypes.ModuleName,\n    ...\n)\n\n// Add packet forward middleware to init genesis logic\napp.moduleManager.SetOrderInitGenesis(\n    ...\n    packetforwardtypes.ModuleName,\n    ...\n)\n\n// Add packet forward middleware to init params keeper\nfunc initParamsKeeper(appCodec codec.BinaryCodec, legacyAmino *codec.LegacyAmino, key, tkey storetypes.StoreKey) paramskeeper.Keeper {\n    ...\n    paramsKeeper.Subspace(packetforwardtypes.ModuleName).WithKeyTable(packetforwardtypes.ParamKeyTable())\n    ...\n}\n'})}),"\n",(0,n.jsx)(r.h2,{id:"configuring-the-transfer-application-stack-with-packet-forward-middleware",children:"Configuring the transfer application stack with Packet Forward Middleware"}),"\n",(0,n.jsxs)(r.p,{children:["Here is an example of how to create an application stack using ",(0,n.jsx)(r.code,{children:"transfer"})," and ",(0,n.jsx)(r.code,{children:"packet-forward-middleware"}),".\nThe following ",(0,n.jsx)(r.code,{children:"transferStack"})," is configured in ",(0,n.jsx)(r.code,{children:"app/app.go"})," and added to the IBC ",(0,n.jsx)(r.code,{children:"Router"}),".\nThe in-line comments describe the execution flow of packets between the application stack and IBC core."]}),"\n",(0,n.jsxs)(r.p,{children:["For more information on configuring an IBC application stack see the ibc-go docs ",(0,n.jsx)(r.a,{href:"https://github.com/cosmos/ibc-go/blob/e69a833de764fa0f5bdf0338d9452fd6e579a675/docs/docs/04-middleware/01-ics29-fee/02-integration.md#configuring-an-application-stack-with-fee-middleware",children:"here"}),"."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:"// Create Transfer Stack\n// SendPacket, since it is originating from the application to core IBC:\n// transferKeeper.SendPacket -> packetforward.SendPacket -> channel.SendPacket\n\n// RecvPacket, message that originates from core IBC and goes down to app, the flow is the other way\n// channel.RecvPacket -> packetforward.OnRecvPacket -> transfer.OnRecvPacket\n\n// transfer stack contains (from top to bottom):\n// - Packet Forward Middleware\n// - Transfer\nvar transferStack ibcporttypes.IBCModule\ntransferStack = transfer.NewIBCModule(app.TransferKeeper)\ntransferStack = packetforward.NewIBCMiddleware(\n    transferStack,\n    app.PacketForwardKeeper,\n    0, // retries on timeout\n    packetforwardkeeper.DefaultForwardTransferPacketTimeoutTimestamp, // forward timeout\n)\n\n// Add transfer stack to IBC Router\nibcRouter.AddRoute(ibctransfertypes.ModuleName, transferStack)\n"})}),"\n",(0,n.jsx)(r.h2,{id:"configurable-options-in-the-packet-forward-middleware",children:"Configurable options in the Packet Forward Middleware"}),"\n",(0,n.jsxs)(r.p,{children:["The Packet Forward Middleware has several configurable options available when initializing the IBC application stack.\nYou can see these passed in as arguments to ",(0,n.jsx)(r.code,{children:"packetforward.NewIBCMiddleware"})," and they include the number of retries that\nwill be performed on a forward timeout, the timeout period that will be used for a forward, and the timeout period that\nwill be used for performing refunds in the case that a forward is taking too long."]}),"\n",(0,n.jsxs)(r.p,{children:["Additionally, there is a fee percentage parameter that can be set in ",(0,n.jsx)(r.code,{children:"InitGenesis"}),", this is an optional parameter that\ncan be used to take a fee from each forwarded packet which will then be distributed to the community pool. In the\n",(0,n.jsx)(r.code,{children:"OnRecvPacket"})," callback ",(0,n.jsx)(r.code,{children:"ForwardTransferPacket"})," is invoked which will attempt to subtract a fee from the forwarded\npacket amount if the fee percentage is non-zero."]}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"Retries On Timeout - how many times will a forward be re-attempted in the case of a timeout."}),"\n",(0,n.jsx)(r.li,{children:"Timeout Period - how long can a forward be in progress before giving up."}),"\n",(0,n.jsx)(r.li,{children:"Refund Timeout - how long can a forward be in progress before issuing a refund back to the original source chain."}),"\n",(0,n.jsx)(r.li,{children:"Fee Percentage - % of the forwarded packet amount which will be subtracted and distributed to the community pool."}),"\n"]})]})}function l(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(s,{...e})}):s(e)}},28453:(e,r,a)=>{a.d(r,{R:()=>o,x:()=>d});var n=a(96540);const t={},i=n.createContext(t);function o(e){const r=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),n.createElement(i.Provider,{value:r},e.children)}}}]);