"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[11155],{28453:(e,a,t)=>{t.d(a,{R:()=>s,x:()=>o});var n=t(96540);const r={},i=n.createContext(r);function s(e){const a=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function o(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),n.createElement(i.Provider,{value:a},e.children)}},96183:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var n=t(74848),r=t(28453);const i={title:"Integration",sidebar_label:"Integration",sidebar_position:2,slug:"/middleware/callbacks/integration"},s="Integration",o={id:"middleware/callbacks/integration",title:"Integration",description:"Learn how to integrate the callbacks middleware with IBC applications. The following document is intended for developers building on top of the Cosmos SDK and only applies for Cosmos SDK chains.",source:"@site/docs/04-middleware/01-callbacks/02-integration.md",sourceDirName:"04-middleware/01-callbacks",slug:"/middleware/callbacks/integration",permalink:"/main/middleware/callbacks/integration",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Integration",sidebar_label:"Integration",sidebar_position:2,slug:"/middleware/callbacks/integration"},sidebar:"defaultSidebar",previous:{title:"Overview",permalink:"/main/middleware/callbacks/overview"},next:{title:"Interfaces",permalink:"/main/middleware/callbacks/interfaces"}},c={},l=[{value:"Pre-requisite Readings",id:"pre-requisite-readings",level:2},{value:"Configuring an application stack with the callbacks middleware",id:"configuring-an-application-stack-with-the-callbacks-middleware",level:2},{value:"Transfer",id:"transfer",level:3}];function d(e){const a={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(a.h1,{id:"integration",children:"Integration"}),"\n",(0,n.jsx)(a.p,{children:"Learn how to integrate the callbacks middleware with IBC applications. The following document is intended for developers building on top of the Cosmos SDK and only applies for Cosmos SDK chains."}),"\n",(0,n.jsx)(a.admonition,{type:"tip",children:(0,n.jsxs)(a.p,{children:["An example integration for an IBC v2 transfer stack using the callbacks middleware can be found in the ",(0,n.jsx)(a.a,{href:"/main/ibc/integration",children:"ibc-go module integration"})," section"]})}),"\n",(0,n.jsx)(a.p,{children:"The callbacks middleware is a minimal and stateless implementation of the IBC middleware interface. It does not have a keeper, nor does it store any state. It simply routes IBC middleware messages to the appropriate callback function, which is implemented by the secondary application. Therefore, it doesn't need to be registered as a module, nor does it need to be added to the module manager. It only needs to be added to the IBC application stack."}),"\n",(0,n.jsx)(a.h2,{id:"pre-requisite-readings",children:"Pre-requisite Readings"}),"\n",(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsx)(a.li,{children:(0,n.jsx)(a.a,{href:"/main/ibc/middleware/develop",children:"IBC middleware development"})}),"\n",(0,n.jsx)(a.li,{children:(0,n.jsx)(a.a,{href:"/main/ibc/middleware/integration",children:"IBC middleware integration"})}),"\n"]}),"\n",(0,n.jsxs)(a.p,{children:["The callbacks middleware, as the name suggests, plays the role of an IBC middleware and as such must be configured by chain developers to route and handle IBC messages correctly.\nFor Cosmos SDK chains this setup is done via the ",(0,n.jsx)(a.code,{children:"app/app.go"})," file, where modules are constructed and configured in order to bootstrap the blockchain application."]}),"\n",(0,n.jsx)(a.h2,{id:"configuring-an-application-stack-with-the-callbacks-middleware",children:"Configuring an application stack with the callbacks middleware"}),"\n",(0,n.jsxs)(a.p,{children:["As mentioned in ",(0,n.jsx)(a.a,{href:"/main/ibc/middleware/develop",children:"IBC middleware development"})," an application stack may be composed of many or no middlewares that nest a base application.\nThese layers form the complete set of application logic that enable developers to build composable and flexible IBC application stacks.\nFor example, an application stack may just be a single base application like ",(0,n.jsx)(a.code,{children:"transfer"}),", however, the same application stack composed with ",(0,n.jsx)(a.code,{children:"packet-forward-middleware"})," and ",(0,n.jsx)(a.code,{children:"callbacks"})," will nest the ",(0,n.jsx)(a.code,{children:"transfer"})," base application twice by wrapping it with the callbacks module and then packet forward middleware."]}),"\n",(0,n.jsxs)(a.p,{children:["The callbacks middleware also ",(0,n.jsx)(a.strong,{children:"requires"})," a secondary application that will receive the callbacks to implement the ",(0,n.jsx)(a.a,{href:"https://github.com/cosmos/ibc-go/blob/main/modules/apps/callbacks/types/expected_keepers.go#L12-L100",children:(0,n.jsx)(a.code,{children:"ContractKeeper"})}),". The wasmd contract keeper has been implemented ",(0,n.jsx)(a.a,{href:"https://github.com/CosmWasm/wasmd/tree/main/x/wasm/keeper",children:"here"})," and is referenced as the ",(0,n.jsx)(a.code,{children:"WasmKeeper"}),"."]}),"\n",(0,n.jsx)(a.h3,{id:"transfer",children:"Transfer"}),"\n",(0,n.jsxs)(a.p,{children:["See below for an example of how to create an application stack using ",(0,n.jsx)(a.code,{children:"transfer"}),", ",(0,n.jsx)(a.code,{children:"packet-forward-middleware"}),", and ",(0,n.jsx)(a.code,{children:"callbacks"}),". Feel free to omit the ",(0,n.jsx)(a.code,{children:"packet-forward-middleware"})," if you do not want to use it.\nThe following ",(0,n.jsx)(a.code,{children:"transferStack"})," is configured in ",(0,n.jsx)(a.code,{children:"app/app.go"})," and added to the IBC ",(0,n.jsx)(a.code,{children:"Router"}),".\nThe in-line comments describe the execution flow of packets between the application stack and IBC core."]}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-go",children:"// Create Transfer Stack\n// SendPacket, since it is originating from the application to core IBC:\n// transferKeeper.SendPacket -> callbacks.SendPacket -> feeKeeper.SendPacket -> channel.SendPacket\n\n// RecvPacket, message that originates from core IBC and goes down to app, the flow is the other way\n// channel.RecvPacket -> fee.OnRecvPacket -> callbacks.OnRecvPacket -> transfer.OnRecvPacket\n\n// transfer stack contains (from top to bottom):\n// - IBC Packet Forward Middleware\n// - IBC Callbacks Middleware\n// - Transfer\n\n// initialise the gas limit for callbacks, recommended to be 10M for use with cosmwasm contracts\nmaxCallbackGas := uint64(10_000_000)\n\n// the keepers for the callbacks middleware\nwasmStackIBCHandler := wasm.NewIBCHandler(app.WasmKeeper, app.IBCKeeper.ChannelKeeper, app.IBCKeeper.ChannelKeeper)\n\n// create IBC module from bottom to top of stack\n// Create Transfer Stack\n\tvar transferStack porttypes.IBCModule\n\ttransferStack = transfer.NewIBCModule(app.TransferKeeper)\n// callbacks wraps the transfer stack as its base app, and uses PacketForwardKeeper as the ICS4Wrapper\n// i.e. packet-forward-middleware is higher on the stack and sits between callbacks and the ibc channel keeper\n// Since this is the lowest level middleware of the transfer stack, it should be the first entrypoint for transfer keeper's\n// WriteAcknowledgement.\n\tcbStack := ibccallbacks.NewIBCMiddleware(transferStack, app.PacketForwardKeeper, wasmStackIBCHandler, maxCallbackGas)\n\ttransferStack = packetforward.NewIBCMiddleware(\n\t\tcbStack,\n\t\tapp.PacketForwardKeeper,\n\t\t0,\n\t\tpacketforwardkeeper.DefaultForwardTransferPacketTimeoutTimestamp,\n\t)\n\tapp.TransferKeeper.WithICS4Wrapper(cbStack)\n\n// Create static IBC router, add app routes, then set and seal it\n\tibcRouter := porttypes.NewRouter()\n\tibcRouter.AddRoute(ibctransfertypes.ModuleName, transferStack)\n\tibcRouter.AddRoute(wasmtypes.ModuleName, wasmStackIBCHandler)\n\tapp.IBCKeeper.SetRouter(ibcRouter)\n"})})]})}function p(e={}){const{wrapper:a}={...(0,r.R)(),...e.components};return a?(0,n.jsx)(a,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}}}]);