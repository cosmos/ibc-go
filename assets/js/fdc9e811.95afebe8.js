"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[50200],{28453:(e,n,a)=>{a.d(n,{R:()=>l,x:()=>d});var t=a(96540);const r={},i=t.createContext(r);function l(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(i.Provider,{value:n},e.children)}},38059:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>d,toc:()=>o});var t=a(74848),r=a(28453);const i={title:"Create and integrate IBC v2 middleware",sidebar_label:"Create and integrate IBC v2 middleware",sidebar_position:2,slug:"/ibc/middleware/developIBCv2"},l="Quick Navigation",d={id:"ibc/middleware/developIBCv2",title:"Create and integrate IBC v2 middleware",description:"1. Create a custom IBC v2 middleware",source:"@site/versioned_docs/version-v10.4.x/01-ibc/04-middleware/02-developIBCv2.md",sourceDirName:"01-ibc/04-middleware",slug:"/ibc/middleware/developIBCv2",permalink:"/v10/ibc/middleware/developIBCv2",draft:!1,unlisted:!1,tags:[],version:"v10.4.x",sidebarPosition:2,frontMatter:{title:"Create and integrate IBC v2 middleware",sidebar_label:"Create and integrate IBC v2 middleware",sidebar_position:2,slug:"/ibc/middleware/developIBCv2"},sidebar:"defaultSidebar",previous:{title:"IBC middleware",permalink:"/v10/ibc/middleware/overview"},next:{title:"Create a custom IBC middleware",permalink:"/v10/ibc/middleware/develop"}},c={},o=[{value:"Create a custom IBC v2 middleware",id:"create-a-custom-ibc-v2-middleware",level:2},{value:"Implement <code>IBCModule</code> interface",id:"implement-ibcmodule-interface",level:2},{value:"Packet callbacks",id:"packet-callbacks",level:3},{value:"<code>OnRecvPacket</code>",id:"onrecvpacket",level:4},{value:"<code>OnAcknowledgementPacket</code>",id:"onacknowledgementpacket",level:4},{value:"<code>OnTimeoutPacket</code>",id:"ontimeoutpacket",level:4},{value:"WriteAckWrapper",id:"writeackwrapper",level:3},{value:"<code>WriteAcknowledgement</code>",id:"writeacknowledgement",level:3},{value:"Integrate IBC v2 Middleware",id:"integrate-ibc-v2-middleware",level:2},{value:"Example Integration",id:"example-integration",level:3},{value:"Security Model",id:"security-model",level:2},{value:"Design Principles",id:"design-principles",level:2}];function s(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"quick-navigation",children:"Quick Navigation"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#create-a-custom-ibc-v2-middleware",children:"Create a custom IBC v2 middleware"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsxs)(n.a,{href:"#implement-ibcmodule-interface",children:["Implement ",(0,t.jsx)(n.code,{children:"IBCModule"})," interface"]})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#writeackwrapper",children:"WriteAckWrapper"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#integrate-ibc-v2-middleware",children:"Integrate IBC v2 Middleware"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#security-model",children:"Security Model"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#design-principles",children:"Design Principles"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"create-a-custom-ibc-v2-middleware",children:"Create a custom IBC v2 middleware"}),"\n",(0,t.jsx)(n.p,{children:"IBC middleware will wrap over an underlying IBC application (a base application or downstream middleware) and sits between core IBC and the base application."}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsx)(n.p,{children:"middleware developers must use the same serialization and deserialization method as in ibc-go's codec: transfertypes.ModuleCdc.[Must]MarshalJSON"})}),"\n",(0,t.jsx)(n.p,{children:"For middleware builders this means:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'import transfertypes "github.com/cosmos/ibc-go/v10/modules/apps/transfer/types"\ntransfertypes.ModuleCdc.[Must]MarshalJSON\nfunc MarshalAsIBCDoes(ack channeltypes.Acknowledgement) ([]byte, error) {\n\treturn transfertypes.ModuleCdc.MarshalJSON(&ack)\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["The interfaces a middleware must implement are found in ",(0,t.jsx)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/main/modules/core/api/module.go#L11",children:"core/api"}),". Note that this interface has changed from IBC classic."]}),"\n",(0,t.jsxs)(n.p,{children:["An ",(0,t.jsx)(n.code,{children:"IBCMiddleware"})," struct implementing the ",(0,t.jsx)(n.code,{children:"Middleware"})," interface, can be defined with its constructor as follows:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// @ x/module_name/ibc_middleware.go\n\n// IBCMiddleware implements the IBCv2 middleware interface\ntype IBCMiddleware struct {\n  app                   api.IBCModule // underlying app or middleware\n  writeAckWrapper       api. WriteAcknowledgementWrapper // writes acknowledgement for an async acknowledgement\n  PacketDataUnmarshaler api.PacketDataUnmarshaler // optional interface\n  keeper                types.Keeper // required for stateful middleware\n  // Keeper may include middleware specific keeper and the ChannelKeeperV2\n\n  // additional middleware specific fields \n}\n\n// NewIBCMiddleware creates a new IBCMiddleware given the keeper and underlying application\nfunc NewIBCMiddleware(app api.IBCModule, \nwriteAckWrapper api.WriteAcknowledgementWrapper, \nk types.Keeper\n) IBCMiddleware {\n  return IBCMiddleware{\n    app:             app,\n    writeAckWrapper: writeAckWrapper,\n    keeper:          k,\n  }\n}\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsx)(n.p,{children:"The ICS4Wrapper has been removed in IBC v2 and there are no channel handshake callbacks, a writeAckWrapper has been added to the interface"})}),"\n",(0,t.jsxs)(n.h2,{id:"implement-ibcmodule-interface",children:["Implement ",(0,t.jsx)(n.code,{children:"IBCModule"})," interface"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"IBCMiddleware"})," is a struct that implements the ",(0,t.jsxs)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/main/modules/core/api/module.go#L11-L53",children:[(0,t.jsx)(n.code,{children:"IBCModule"})," interface (",(0,t.jsx)(n.code,{children:"api.IBCModule"}),")"]}),". It is recommended to separate these callbacks into a separate file ",(0,t.jsx)(n.code,{children:"ibc_middleware.go"}),"."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Note how this is analogous to implementing the same interfaces for IBC applications that act as base applications."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The middleware must have access to the underlying application, and be called before it during all ICS-26 callbacks. It may execute custom logic during these callbacks, and then call the underlying application's callback."}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Middleware ",(0,t.jsx)(n.strong,{children:"may"})," choose not to call the underlying application's callback at all. Though these should generally be limited to error cases."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"IBCModule"})," interface consists of the packet callbacks where custom logic is performed."]}),"\n",(0,t.jsx)(n.h3,{id:"packet-callbacks",children:"Packet callbacks"}),"\n",(0,t.jsx)(n.p,{children:"The packet callbacks are where the middleware performs most of its custom logic. The middleware may read the packet flow data and perform some additional packet handling, or it may modify the incoming data before it reaches the underlying application. This enables a wide degree of usecases, as a simple base application like token-transfer can be transformed for a variety of usecases by combining it with custom middleware, for example acting as a filter for which tokens can be sent and received."}),"\n",(0,t.jsx)(n.h4,{id:"onrecvpacket",children:(0,t.jsx)(n.code,{children:"OnRecvPacket"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (im IBCMiddleware) OnRecvPacket(\n  ctx sdk.Context,\n\tsourceClient string,\n\tdestinationClient string,\n\tsequence uint64,\n\tpayload channeltypesv2.Payload,\n\trelayer sdk.AccAddress,\n) channeltypesv2.RecvPacketResult {\n\t// Middleware may choose to do custom preprocessing logic before calling the underlying app OnRecvPacket\n    // Middleware may choose to error early and return a RecvPacketResult Failure\n    // Middleware may choose to modify the payload before passing on to OnRecvPacket though this\n    // should only be done to support very advanced custom behavior\n    // Middleware MUST NOT modify client identifiers and sequence\n    doCustomPreProcessLogic()\n    \n\t// call underlying app OnRecvPacket\n    recvResult := im.app.OnRecvPacket(ctx, sourceClient, destinationClient, sequence, payload, relayer)\n\tif recvResult.Status == PACKET_STATUS_FAILURE {\n\t\treturn recvResult\n\t}\n\n    doCustomPostProcessLogic(recvResult) // middleware may modify recvResult\n    \n    return recvResult\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/main/modules/apps/callbacks/v2/ibc_middleware.go#L161-L230",children:"here"})," an example implementation of this callback for the Callbacks Middleware module."]}),"\n",(0,t.jsx)(n.h4,{id:"onacknowledgementpacket",children:(0,t.jsx)(n.code,{children:"OnAcknowledgementPacket"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (im IBCMiddleware) OnAcknowledgementPacket(\n  ctx sdk.Context,\n\tsourceClient string,\n\tdestinationClient string,\n\tsequence uint64,\n\tacknowledgement []byte,\n\tpayload channeltypesv2.Payload,\n\trelayer sdk.AccAddress,\n) error {\n\t// preprocessing logic may modify the acknowledgement before passing to \n\t// the underlying app though this should only be done in advanced cases\n\t// Middleware may return error early\n\t// it MUST NOT change the identifiers of the clients or the sequence\n\tdoCustomPreProcessLogic(payload, acknowledgement)\n\n\t// call underlying app OnAcknowledgementPacket\n\terr = im.app.OnAcknowledgementPacket(\n\t\tsourceClient, destinationClient, sequence,\n\t\tacknowledgement, payload, relayer\n\t)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// may perform some post acknowledgement logic and return error here\n\treturn doCustomPostProcessLogic()\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/main/modules/apps/callbacks/v2/ibc_middleware.go#L236-L302",children:"here"})," an example implementation of this callback for the Callbacks Middleware module."]}),"\n",(0,t.jsx)(n.h4,{id:"ontimeoutpacket",children:(0,t.jsx)(n.code,{children:"OnTimeoutPacket"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"func (im IBCMiddleware) OnTimeoutPacket(\n  ctx sdk.Context,\n\tsourceClient string,\n\tdestinationClient string,\n\tsequence uint64,\n\tpayload channeltypesv2.Payload,\n\trelayer sdk.AccAddress,\n) error {\n\t// Middleware may choose to do custom preprocessing logic before calling the underlying app OnTimeoutPacket\n\t// Middleware may return error early\n\tdoCustomPreProcessLogic(payload)\n\n\t// call underlying app OnTimeoutPacket\n\terr = im.app.OnTimeoutPacket(\n\t\tsourceClient, destinationClient, sequence,\n\t\tpayload, relayer\n\t)\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// may perform some post timeout logic and return error here\n\treturn doCustomPostProcessLogic()\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/main/modules/apps/callbacks/v2/ibc_middleware.go#L309-L367",children:"here"})," an example implementation of this callback for the Callbacks Middleware module."]}),"\n",(0,t.jsx)(n.h3,{id:"writeackwrapper",children:"WriteAckWrapper"}),"\n",(0,t.jsxs)(n.p,{children:["Middleware must also wrap the ",(0,t.jsx)(n.code,{children:"WriteAcknowledgement"})," interface so that any acknowledgement written by the application passes through the middleware first. This allows middleware to modify or delay writing an acknowledgment before committed to the IBC store."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// WithWriteAckWrapper sets the WriteAcknowledgementWrapper for the middleware.\nfunc (im *IBCMiddleware) WithWriteAckWrapper(writeAckWrapper api.WriteAcknowledgementWrapper) {\n\tim.writeAckWrapper = writeAckWrapper\n}\n\n// GetWriteAckWrapper returns the WriteAckWrapper\nfunc (im *IBCMiddleware) GetWriteAckWrapper() api.WriteAcknowledgementWrapper {\n\treturn im.writeAckWrapper\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"writeacknowledgement",children:(0,t.jsx)(n.code,{children:"WriteAcknowledgement"})}),"\n",(0,t.jsxs)(n.p,{children:["This is where the middleware acknowledgement handling is finalised. An example is shown in the ",(0,t.jsx)(n.a,{href:"https://github.com/cosmos/ibc-go/blob/main/modules/apps/callbacks/v2/ibc_middleware.go#L369-L454",children:"callbacks middleware"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// WriteAcknowledgement facilitates acknowledgment being written asynchronously\n// The call stack flows from the IBC application to the IBC core handler\n// Thus this function is called by the IBC app or a lower-level middleware\nfunc (im IBCMiddleware) WriteAcknowledgement(\n\tctx sdk.Context,\n\tclientID string,\n\tsequence uint64,\n\tack channeltypesv2.Acknowledgement,\n) error {\n\tdoCustomPreProcessLogic() // may modify acknowledgement\n\n\treturn im.writeAckWrapper.WriteAcknowledgement(\n\t\tctx, clientId, sequence, ack,\n\t)\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"integrate-ibc-v2-middleware",children:"Integrate IBC v2 Middleware"}),"\n",(0,t.jsxs)(n.p,{children:["Middleware should be registered within the module manager in ",(0,t.jsx)(n.code,{children:"app.go"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["The order of middleware ",(0,t.jsx)(n.strong,{children:"matters"}),", function calls from IBC to the application travel from top-level middleware to the bottom middleware and then to the application. Function calls from the application to IBC goes through the bottom middleware in order to the top middleware and then to core IBC handlers. Thus the same set of middleware put in different orders may produce different effects."]}),"\n",(0,t.jsx)(n.h3,{id:"example-integration",children:"Example Integration"}),"\n",(0,t.jsx)(n.p,{children:"The example integration is detailed for an IBC v2 stack using transfer and the callbacks middleware."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:"// Middleware Stacks\n// initialising callbacks middleware  \n\tmaxCallbackGas := uint64(10_000_000)\n\twasmStackIBCHandler := wasm.NewIBCHandler(app.WasmKeeper, app.IBCKeeper.ChannelKeeper, app.IBCKeeper.ChannelKeeper)\n\n// Create the transferv2 stack with transfer and callbacks middleware\n  var ibcv2TransferStack ibcapi.IBCModule\n\tibcv2TransferStack = transferv2.NewIBCModule(app.TransferKeeper)\n\tibcv2TransferStack = ibccallbacksv2.NewIBCMiddleware(transferv2.NewIBCModule(app.TransferKeeper), app.IBCKeeper.ChannelKeeperV2, wasmStackIBCHandler, app.IBCKeeper.ChannelKeeperV2, maxCallbackGas)\n\n// Create static IBC v2 router, add app routes, then set and seal it\n  ibcRouterV2 := ibcapi.NewRouter()\n\tibcRouterV2.AddRoute(ibctransfertypes.PortID, ibcv2TransferStack)\n\tapp.IBCKeeper.SetRouterV2(ibcRouterV2)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"security-model",children:"Security Model"}),"\n",(0,t.jsxs)(n.p,{children:["IBC Middleware completely wraps all communication between IBC core and the application that it is wired with. Thus, the IBC Middleware has complete control to modify any packets and acknowledgements the underlying application receives or sends. Thus, if a chain chooses to wrap an application with a given middleware, that middleware is ",(0,t.jsx)(n.strong,{children:"completely trusted"})," and part of the application's security model. ",(0,t.jsx)(n.strong,{children:"Do not use middlewares that are untrusted."})]}),"\n",(0,t.jsx)(n.h2,{id:"design-principles",children:"Design Principles"}),"\n",(0,t.jsxs)(n.p,{children:["The middleware follows a decorator pattern that wraps an underlying application's connection to the IBC core handlers. Thus, when implementing a middleware for a specific purpose, it is recommended to be as ",(0,t.jsx)(n.strong,{children:"unintrusive"})," as possible in the middleware design while still accomplishing the intended behavior."]}),"\n",(0,t.jsx)(n.p,{children:"The least intrusive middleware is stateless. They simply read the ICS26 callback arguments before calling the underlying app's callback and error if the arguments are not acceptable (e.g. whitelisting packets). Stateful middleware that are used solely for erroring are also very simple to build, an example of this would be a rate-limiting middleware that prevents transfer outflows from getting too high within a certain time frame."}),"\n",(0,t.jsx)(n.p,{children:"Middleware that directly interfere with the payload or acknowledgement before passing control to the underlying app are way more intrusive to the underlying app processing. This makes such middleware more error-prone when implementing as incorrect handling can cause the underlying app to break or worse execute unexpected behavior. Moreover, such middleware typically needs to be built for a specific underlying app rather than being generic. An example of this is the packet-forwarding middleware which modifies the payload and is specifically built for transfer."}),"\n",(0,t.jsx)(n.p,{children:"Middleware that modifies the payload or acknowledgement such that it is no longer readable by the underlying application is the most complicated middleware. Since it is not readable by the underlying apps, if these middleware write additional state into payloads and acknowledgements that get committed to IBC core provable state, there MUST be an equivalent counterparty middleware that is able to parse and interpret this additional state while also converting the payload and acknowledgment back to a readable form for the underlying application on its side. Thus, such middleware requires deployment on both sides of an IBC connection or the packet processing will break. This is the hardest type of middleware to implement, integrate and deploy. Thus, it is not recommended unless absolutely necessary to fulfill the given use case."})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(s,{...e})}):s(e)}}}]);